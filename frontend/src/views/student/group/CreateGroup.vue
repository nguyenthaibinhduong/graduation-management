<template>
    <div>
        <div class="w-full mx-auto mt-3 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-md text-blue-900 shadow-sm">
            <h3 class="text-lg font-semibold mb-2">
                üìù H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng ch·ª©c nƒÉng ƒëƒÉng k√Ω nh√≥m
            </h3>

            <ul class="list-inside text-sm space-y-2">
                <template v-if="!showMore">
                    <!-- R√∫t g·ªçn: ch·ªâ hi·ªÉn th·ªã 3 ph·∫ßn ƒë·∫ßu -->
                    <li><strong>1.T·∫°o nh√≥m m·ªõi</strong></li>
                    <ul class="list-inside space-y-1">
                        <li>
                            <strong>ƒêƒÉng k√Ω 1 m√¨nh:</strong> B·∫°n c√≥ th·ªÉ t·∫°o nh√≥m cho ri√™ng m√¨nh. Nh√≥m s·∫Ω
                            c√≥ tr·∫°ng th√°i <span class="font-bold">Pending</span> (ƒëang ch·ªù duy·ªát). H·ªá
                            th·ªëng s·∫Ω t·∫°o m√£ nh√≥m duy nh·∫•t cho b·∫°n.
                        </li>
                        <li>
                            <strong>M·ªùi th√™m th√†nh vi√™n v√†o nh√≥m:</strong> B·∫°n c√≥ th·ªÉ m·ªùi c√°c sinh vi√™n
                            kh√°c tham gia nh√≥m. Nh√≥m s·∫Ω c√≥ tr·∫°ng th√°i
                            <span class="font-bold">Create</span> (ƒëang l·∫≠p nh√≥m), v√† c√°c th√†nh vi√™n b·∫°n
                            m·ªùi s·∫Ω nh·∫≠n l·ªùi m·ªùi tham gia nh√≥m.
                        </li>
                    </ul>

                    <li><strong>2.Ch·∫•p nh·∫≠n ho·∫∑c t·ª´ ch·ªëi l·ªùi m·ªùi</strong></li>
                    <ul class="list-inside space-y-1">
                        <li>
                            <strong>Ch·∫•p nh·∫≠n l·ªùi m·ªùi:</strong> Khi sinh vi√™n ƒë∆∞·ª£c m·ªùi ch·∫•p nh·∫≠n l·ªùi m·ªùi,
                            nh√≥m s·∫Ω chuy·ªÉn sang tr·∫°ng th√°i <span class="font-bold">Pending</span> (ƒëang
                            ch·ªù duy·ªát). C√°c th√†nh vi√™n s·∫Ω ch·ªù gi√°o v·ª• duy·ªát nh√≥m.
                        </li>
                        <li>
                            <strong>T·ª´ ch·ªëi l·ªùi m·ªùi:</strong> N·∫øu m·ªôt th√†nh vi√™n t·ª´ ch·ªëi l·ªùi m·ªùi, nh√≥m s·∫Ω
                            c·∫≠p nh·∫≠t sang tr·∫°ng th√°i nh√≥m 1 th√†nh vi√™n
                        </li>
                    </ul>
                </template>
                <template v-else>
                    <li><strong>1.T·∫°o nh√≥m m·ªõi</strong></li>
                    <ul class="list-inside space-y-1">
                        <li>
                            <strong>ƒêƒÉng k√Ω 1 m√¨nh:</strong> B·∫°n c√≥ th·ªÉ t·∫°o nh√≥m cho ri√™ng m√¨nh. Nh√≥m s·∫Ω
                            c√≥ tr·∫°ng th√°i <span class="font-bold">Pending</span> (ƒëang ch·ªù duy·ªát). H·ªá
                            th·ªëng s·∫Ω t·∫°o m√£ nh√≥m duy nh·∫•t cho b·∫°n.
                        </li>
                        <li>
                            <strong>M·ªùi th√™m th√†nh vi√™n v√†o nh√≥m:</strong> B·∫°n c√≥ th·ªÉ m·ªùi c√°c sinh vi√™n
                            kh√°c tham gia nh√≥m. Nh√≥m s·∫Ω c√≥ tr·∫°ng th√°i
                            <span class="font-bold">Create</span> (ƒëang l·∫≠p nh√≥m), v√† c√°c th√†nh vi√™n b·∫°n
                            m·ªùi s·∫Ω nh·∫≠n l·ªùi m·ªùi tham gia nh√≥m.
                        </li>
                    </ul>

                    <li><strong>2.Ch·∫•p nh·∫≠n ho·∫∑c t·ª´ ch·ªëi l·ªùi m·ªùi</strong></li>
                    <ul class="list-inside space-y-1">
                        <li>
                            <strong>Ch·∫•p nh·∫≠n l·ªùi m·ªùi:</strong> Khi sinh vi√™n ƒë∆∞·ª£c m·ªùi ch·∫•p nh·∫≠n l·ªùi m·ªùi,
                            nh√≥m s·∫Ω chuy·ªÉn sang tr·∫°ng th√°i <span class="font-bold">Pending</span> (ƒëang
                            ch·ªù duy·ªát). C√°c th√†nh vi√™n s·∫Ω ch·ªù gi√°o v·ª• duy·ªát nh√≥m.
                        </li>
                        <li>
                            <strong>T·ª´ ch·ªëi l·ªùi m·ªùi:</strong> N·∫øu m·ªôt th√†nh vi√™n t·ª´ ch·ªëi l·ªùi m·ªùi, nh√≥m s·∫Ω
                            c·∫≠p nh·∫≠t sang tr·∫°ng th√°i nh√≥m 1 th√†nh vi√™n
                        </li>
                    </ul>

                    <li><strong>3.Kh√≥a nh√≥m v√† duy·ªát nh√≥m</strong></li>
                    <ul class="list-inside space-y-1">
                        <li>
                            Khi ƒë·∫øn ƒë·ª£t kh√≥a nh√≥m, c√°c nh√≥m c√≥ tr·∫°ng th√°i
                            <span class="font-bold">Pending</span> s·∫Ω t·ª± ƒë·ªông chuy·ªÉn th√†nh
                            <span class="font-bold">Approved</span> (ƒë√£ duy·ªát).
                        </li>
                        <li>
                            Ch·ªâ khi nh√≥m c√≥ tr·∫°ng th√°i <span class="font-bold">Approved</span>, b·∫°n m·ªõi c√≥
                            th·ªÉ ƒëƒÉng k√Ω ƒë·ªÅ t√†i cho nh√≥m.
                        </li>
                    </ul>

                    <li><strong>4.M·ªùi th√™m th√†nh vi√™n</strong></li>
                    <ul class="list-inside space-y-1">
                        <li>
                            Sau khi nh√≥m ƒë√£ c√≥ √≠t nh·∫•t m·ªôt th√†nh vi√™n, b·∫°n c√≥ th·ªÉ m·ªùi th√™m th√†nh vi√™n v√†o
                            nh√≥m.
                        </li>
                        <li>
                            H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i c·ªßa nh√≥m v√† s·ªë l∆∞·ª£ng th√†nh vi√™n.
                        </li>
                    </ul>

                    <li><strong>5.T·∫°o nh√≥m m·ªõi sau khi h·ªßy nh√≥m c≈©</strong></li>
                    <ul class="list-inside space-y-1">
                        <li>
                            N·∫øu nh√≥m hi·ªán t·∫°i c·ªßa b·∫°n c√≥ tr·∫°ng th√°i kh√°c v·ªõi
                            <span class="font-bold">Approved</span> (ch∆∞a duy·ªát), b·∫°n c·∫ßn h·ªßy nh√≥m c≈© ƒë·ªÉ
                            t·∫°o nh√≥m m·ªõi.
                        </li>
                        <li>
                            H·ªá th·ªëng kh√¥ng cho ph√©p t·∫°o nh√≥m m·ªõi n·∫øu nh√≥m c≈© ch∆∞a ƒë∆∞·ª£c duy·ªát (status !=
                            <span class="font-bold">Approved</span>).
                        </li>
                    </ul>

                    <li><strong>6.Tr∆∞·ªùng h·ª£p nh√≥m ƒë√£ kh√≥a</strong></li>
                    <ul class="list-inside space-y-1">
                        <li>
                            Trong tr∆∞·ªùng h·ª£p nh√≥m ƒë√£ c√≥ tr·∫°ng th√°i
                            <span class="font-bold">Approved</span> v√† b·∫°n mu·ªën m·ªùi th√™m th√†nh vi√™n m·ªõi,
                            b·∫°n c·∫ßn t·∫°o y√™u c·∫ßu ƒëƒÉng k√Ω nh√≥m m·ªõi.
                        </li>
                        <li>Y√™u c·∫ßu s·∫Ω ƒë∆∞·ª£c g·ª≠i cho gi√°o v·ª• duy·ªát nh√≥m m·ªõi.</li>
                    </ul>
                </template>
            </ul>

            <h4 class="text-md font-semibold mt-4">‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng:</h4>
            <ul class="list-disc list-inside text-sm">
                <li><strong>Ch·ªâ sinh vi√™n thu·ªôc c√πng khoa m·ªõi c√≥ th·ªÉ tham gia nh√≥m.</strong></li>
                <li>
                    <strong>Tr∆∞·ªüng nh√≥m nh√≥m kh√°c kh√¥ng th·ªÉ t·∫°o nh√≥m m·ªõi, c·∫ßn h·ªßy nh√≥m c≈©.</strong>
                </li>
                <li><strong>Nh√≥m ƒë√£ ƒë∆∞·ª£c duy·ªát th√¨ kh√¥ng th·ªÉ thay ƒë·ªïi th√†nh vi√™n.</strong></li>
            </ul>

            <!-- N√∫t Toggle -->
            <button @click="showMore = !showMore" class="mt-3 text-sm text-blue-600 underline hover:text-blue-800">
                {{ showMore ? "Thu g·ªçn" : "Xem th√™m " }}
            </button>
        </div>

        <div class="w-full grid gap-x-4" :class="!['approved', 'finding', 'success'].includes(group?.status)
            ? 'grid-cols-2'
            : 'grid-cols-1'
            ">
            <div v-if="!['approved', 'finding', 'success'].includes(group?.status)"
                class="w-full mt-10 mx-auto o p-6 bg-white rounded-xl shadow-sm">
                <h2 class="text-2xl font-semibold mb-4">ƒêƒÉng k√Ω nh√≥m kh√≥a lu·∫≠n</h2>

                <!-- T√™n nh√≥m -->
                <div class="mb-4">
                    <label for="group_name" class="block mb-1 font-medium">T√™n nh√≥m</label>
                    <MyInput type="text" id="group_name" v-model="group_name" class="w-full"
                        placeholder="Nh·∫≠p t√™n nh√≥m" />
                </div>

                <!-- M·ªùi th√†nh vi√™n -->
                <div class="mb-4">
                    <label for="student_code" class="block mb-1 font-medium">M√£ sinh vi√™n (th√†nh vi√™n)</label>
                    <MyInput type="text" id="student_code" v-model="student_code" class="w-full"
                        placeholder="M√£ sinh vi√™n mu·ªën m·ªùi (t·ªëi ƒëa 1 sinh vi√™n)" />
                </div>

                <!-- G·ª≠i l·ªùi m·ªùi -->
                <div class="flex justify-end space-x-2">
                    <Button label="T·∫°o nh√≥m" icon="pi pi-users" @click="createGroup" />
                    <Button label="G·ª≠i l·ªùi m·ªùi" icon="pi pi-send" class="p-button-success" @click="inviteMember" />
                </div>

                <!-- Th√¥ng b√°o -->
            </div>
            <!-- Th√¥ng tin nh√≥m  -->
            <div class="w-full mt-10 p-6 bg-white rounded-xl shadow-sm">
                <h2 class="text-2xl font-semibold mb-4 text-green-700">Th√¥ng tin nh√≥m c·ªßa b·∫°n</h2>
                <div v-if="group?.length < 1 || !group" class="text-gray-500 text-sm">
                    B·∫°n hi·ªán ch∆∞a c√≥ nh√≥m ƒëƒÉng k√Ω
                </div>
                <div v-else class="space-y-2 text-base">
                    <div><span class="font-medium">T√™n nh√≥m:</span> {{ group?.name }}</div>
                    <div><span class="font-medium">M√£ nh√≥m:</span> {{ group?.code }}</div>
                    <div>
                        <span class="font-medium">Tr∆∞·ªüng nh√≥m:</span>
                        {{ group?.leader?.user?.fullname }}
                    </div>
                    <div>
                        <span class="font-medium">Th√†nh vi√™n:</span>
                        <ul class="list-disc list-inside ml-2">
                            <li v-for="member in group?.status == 'create'
                                ? group?.student_attemp
                                : group?.students" :key="member.id">
                                {{ member.user?.fullname }} ({{ member.code }})
                            </li>
                        </ul>
                    </div>
                    <div>
                        <span class="font-medium">Tr·∫°ng th√°i:</span>
                        <span :class="statusClass(group?.status)">{{
                            statusLabel(group?.status)
                        }}</span>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <Button v-if="['create', 'pending'].includes(group?.status) && student?.id != group?.leader?.id"
                            label="R·ªùi nh√≥m" icon="pi pi-sign-out" variant="outlined" severity="danger"
                            @click="cancelGroup(group.id)" />
                        <Button v-if="['create', 'pending'].includes(group?.status) && student?.id == group?.leader?.id"
                            label="H·ªßy nh√≥m" icon="pi pi-user-minus" variant="outlined" severity="danger"
                            @click="cancelGroup(group.id)" />
                    </div>
                </div>
            </div>
        </div>
    </div>

</template>

<script setup>
import { onMounted, ref, watchEffect } from "vue";

import Button from "primevue/button";
import MyInput from "@/components/form/MyInput.vue";
import { useAuthStore } from "@/stores/auth";
import { useGroupStore } from "@/stores/store";
import { showToast } from "@/utils/toast";

const group_name = ref("");
const student_code = ref("");
const authStore = useAuthStore();
const student = ref();
const group = ref(null);
const groupStore = useGroupStore();
const showMore = ref(false);
onMounted(async () => {
    await authStore.fetchUser();
    await groupStore.getMyGroup();
});
watchEffect(() => {
    student.value = authStore.user?.student;
    group.value = groupStore.group;
    console.log(group.value, student.value);
});

const statusLabel = (status) => {
    const statuses = {
        create: "ƒêang l·∫≠p nh√≥m",
        pending: "ƒêang ch·ªù duy·ªát",
        approved: "ƒê√£ duy·ªát",
        reject: "ƒê√£ hu·ª∑",
        finding: "ƒêang ghi danh",
        success: "Th·ª±c hi·ªán ƒë·ªÅ t√†i"
    };
    return statuses[status] || "Kh√¥ng x√°c ƒë·ªãnh";
};

const statusClass = (status) => {
    const classes = {
        create: "bg-blue-100 text-blue-700 px-2  py-1 ms-2 text-sm rounded-full",
        pending: "bg-yellow-100 text-yellow-700 px-2  py-1 ms-2 text-sm rounded-full",
        approved: "bg-green-100 text-green-700 px-2  py-1 ms-2 text-sm rounded-full",
        reject: "bg-red-100 text-red-700 px-2  py-1 ms-2 text-sm rounded-full",
        finding: "bg-yellow-300 text-white px-2  py-1 ms-2 text-sm rounded-full",
        success: "bg-green-600 text-white px-2  py-1 ms-2 text-sm rounded-full",
    };
    return classes[status] || "";
};
// H√†m t·∫°o nh√≥m (logic b·∫°n t·ª± th√™m)
const createGroup = async () => {
    if (!group_name?.value) {
        showToast("Ch∆∞a ƒëi·ªÅn t√™n nh√≥m", "info");
    } else {
        if (!student_code?.value) {
            const param = {
                name: group_name.value,
                student_codes: [student.value?.code],
            };
            if (!group.value) {
                await groupStore.addItem(param);
                await groupStore.getMyGroup();
                console.log(group.value);

                group_name.value = "";
                student_code.value = "";
            } else {
                showToast('Hu·ª∑ nh√≥m hi·ªán t·∫°i ƒë·ªÉ t·∫°o nh√≥m kh√°c', 'info');
            }

        } else {
            await inviteMember();
        }
    }
};

const inviteMember = async () => {
    if (!student_code?.value) {
        showToast("Ch∆∞a ƒëi·ªÅn m√£ sinh vi√™n th√†nh vi√™n", "info");
    } else {
        const param = {
            name: group_name.value,
            student_codes: [student.value?.code, student_code?.value],
        };
        if (!group.value) {
            await groupStore.addItem(param);
            await groupStore.getMyGroup();
            console.log(group.value);

            group_name.value = "";
            student_code.value = "";
        } else {
            showToast('Hu·ª∑ nh√≥m hi·ªán t·∫°i ƒë·ªÉ t·∫°o nh√≥m kh√°c', 'info');
        }


    }
};

const cancelGroup = async (id) => {
    if (id) {
        await groupStore.updateStatus(id);
        await groupStore.getMyGroup();
    }
};
</script>

<style scoped>
/* Th√™m n·∫øu c·∫ßn style ri√™ng */
</style>
